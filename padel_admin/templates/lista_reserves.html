{% extends 'base.html' %}
{% load static %}

{% block title %}Reservas - Paddle Club{% endblock %}

{% block content %}
<h1 class="text-4xl font-bold mb-6">Gestión de Turnos</h1>

<div class="card p-6 mb-8">
  <div class="flex flex-col md:flex-row justify-between items-center mb-6">
    <a class="ui primary button" id="abrir-ventana">
      <span class="inline-flex items-center"><i class="fas fa-plus-circle mr-2"></i> Nuevo Turno</span>
    </a>

    <!-- FILTRO DE FECHA -->
    <form class="mt-4 md:mt-0">
      <div class="flex items-center">
        <label for="fecha" class="mr-2 font-medium">Fecha:</label>
        <input type="date" id="fecha" name="fecha" required class="border border-gray-300 rounded px-3 py-2 mr-2" value="{{ day }}">
        <button type="submit" class="ui primary button"><i class="fas fa-filter mr-1"></i> Filtrar</button>
      </div>
    </form>
  </div>

  {% if mensaje_error %}
  <div class="ui message error">
    <i class="fas fa-exclamation-circle mr-2"></i>
    {{ mensaje_error }}
  </div>
  {% endif %}

  <!-- RESERVES -->
  {% if reserves %}
  <div class="overflow-x-auto">
    <table class="ui very basic celled table">
      <thead>
        <tr class="text-center">
          <th><i class="fas fa-hashtag mr-1"></i> Cancha</th>
          <th><i class="fas fa-tag mr-1"></i> Tipo</th>
          <th><i class="fas fa-clock mr-1"></i> Inicio</th>
          <th><i class="fas fa-hourglass-end mr-1"></i> Finalización</th>
          <th><i class="fas fa-user mr-1"></i> Jugador</th>
          <th><i class="fas fa-dollar-sign mr-1"></i> Cobro</th>
          <th><i class="fas fa-cog mr-1"></i> Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for reserva in reserves %}
        <tr class="text-center">
          <td>{{ reserva.cancha.numero }}</td>
          <td>
            <span class="ui {% if reserva.cancha.tipo == 'Indoor' %}blue{% else %}green{% endif %} label">
              {{ reserva.cancha.tipo }}
            </span>
          </td>
          <td>{{ reserva.hora_inicio }}</td>
          <td>{{ reserva.hora_fin }}</td>
          <td>
            <div class="flex items-center justify-center">
              <img class="ui avatar image mr-2" src="https://ui-avatars.com/api/?name={{ reserva.jugador.nom|first|capfirst }}+{{ reserva.jugador.cognom|first|capfirst }}&background=random">
              {{ reserva.jugador.nom }} {{ reserva.jugador.cognom }}
            </div>
          </td>
          <td>
            <a href="{% url 'lista_cobraments' data=reserva.fecha|date:'Y-m-d' id_jugador=reserva.jugador.id_jugador %}" class="ui teal button">
              <i class="fas fa-dollar-sign"></i> Cobrar
            </a>
          </td>
          <td>
            <a class="ui red button eliminar-reserva" data-info="{{ reserva.jugador.id_jugador }}">
              <i class="fas fa-trash"></i> Eliminar
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="ui placeholder segment">
    <div class="ui icon header">
      <i class="calendar times outline icon"></i>
      No hay turnos para esta fecha
    </div>
    <div class="ui primary button" id="abrir-ventana-empty">Crear un turno</div>
  </div>
  {% endif %}
</div>

<!-- FORMULARI AFEGIR -->
<div id="formulario-popup" class="ui modal">
  <i class="close icon"></i>
  <div class="header">
    <i class="fas fa-calendar-plus mr-2"></i> Nuevo Turno
  </div>
  <div class="content">
    <form method="POST" class="ui form">
      {% csrf_token %}
      <div class="two fields">
        <div class="field">
          <label><i class="fas fa-calendar-day mr-1"></i> Fecha</label>
          <input type="date" id="fecha-2" name="fecha-2" required value="{{ request.GET.fecha|default:day }}">
        </div>
        <div class="field">
          <label><i class="fas fa-clock mr-1"></i> Hora de inicio</label>
          <select name="horaInici" class="ui dropdown">
            <option value="">Seleccioná la hora</option>
            {% for hour in hours %}
              <option value="{{ hour }}" {% if request.GET.hora == hour %}selected{% endif %}>{{ hour }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="two fields">
        <div class="field">
          <label><i class="fas fa-hourglass mr-1"></i> Duración</label>
          <select name="horaFinalitzacio" class="ui dropdown">
            <option value="">Seleccioná la duración</option>
            <option value="30">30 minutos</option>
            <option value="60">1 hora</option>
            <option value="90">1 hora y 30 minutos</option>
          </select>
        </div>
        <div class="field">
          <label><i class="fas fa-table-tennis mr-1"></i> Tipo de cancha</label>
          <select name="Pista" class="ui dropdown" id="tipo_cancha_select">
            <option value="">Seleccioná tipo de cancha</option>
            <option value="Indoor" {% if request.GET.tipo == 'Indoor' %}selected{% endif %}>Techada</option>
            <option value="Outdoor" {% if request.GET.tipo == 'Outdoor' %}selected{% endif %}>Al aire libre</option>
          </select>
        </div>
        <div class="field">
          <label><i class="fas fa-hashtag mr-1"></i> Número de cancha</label>
          <select name="cancha_numero" class="ui dropdown" id="cancha_numero_select">
            <option value="">Seleccioná número de cancha</option>
            {% for pista in pistas_disponibles %}
              <option value="{{ pista.numero }}" data-tipo="{{ pista.tipo }}" {% if request.GET.cancha == pista.numero|stringformat:'s' %}selected{% endif %}>{{ pista.numero }} ({{ pista.tipo }})</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="two fields">
        <div class="field">
          <label><i class="fas fa-user mr-1"></i> Seleccionar jugador</label>
          <select name="jugador_select" id="jugador_select" class="ui search dropdown">
            <option value="">Seleccioná un jugador</option>
            {% for jugador in jugadores_registrados %}
              <option value="{{ jugador.nom }}|{{ jugador.cognom }}">{{ jugador.nom }} {{ jugador.cognom }} ({{ jugador.id_jugador }})</option>
            {% endfor %}
          </select>
          <div id="jugador-warning" class="ui warning message mt-2" style="display:none;"></div>
        </div>
      </div>
      <button class="ui primary button fluid" type="submit">
        <i class="fas fa-save mr-1"></i> Guardar Turno
      </button>
    </form>
  </div>
</div>

<!-- AVÍS ELIMINACIÓ DE RESERVA -->
<div class="ui basic modal eliminar-reserva-popup">
  <div class="ui icon header">
    <i class="trash alternate outline icon"></i>
    Confirmar Eliminación
  </div>
  <div class="content text-center">
    <p class="text-lg">¿Estás seguro que querés eliminar este turno?</p>
    <p class="text-sm text-gray-500">Esta acción no se puede deshacer.</p>
  </div>
  <div class="actions flex justify-center">
    <div class="ui red cancel button">
      <i class="remove icon"></i>
      Cancelar
    </div>
    <form id="eliminar-reserva-form" method="POST" action="{% url 'lista_reserves' %}">
      {% csrf_token %}
      <input type="hidden" name="_method" value="DELETE">
      <input type="hidden" name="jugador_id" value="">
      <input type="hidden" name="data" value="">
      <button type="submit" class="ui green ok button">
        <i class="checkmark icon"></i>
        Confirmar
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  var fechaGlobal = document.getElementById('fecha').value;
  document.getElementById('fecha').addEventListener('change', function() {
    fechaGlobal = this.value;
  });
  
  $(document).ready(function() {
    $('.popup').popup();
    
    $('#abrir-ventana, #abrir-ventana-empty').on('click', function() {
      $('#formulario-popup').modal('show');
    });
    
    $('.eliminar-reserva').on('click', function() {
      var jugadorId = $(this).data('info');
      $('#eliminar-reserva-form input[name="jugador_id"]').val(jugadorId);
      $('#eliminar-reserva-form input[name="data"]').val(fechaGlobal);
      $('.eliminar-reserva-popup').modal('show');
    });
    
    // Inicializar dropdowns
    $('.ui.dropdown').dropdown();
    
    // Filtrar número de cancha según tipo
    $('#tipo_cancha_select').on('change', function() {
      var tipo = $(this).val();
      $('#cancha_numero_select option').each(function() {
        if (!tipo || $(this).attr('data-tipo') === tipo || $(this).val() === "") {
          $(this).show();
        } else {
          $(this).hide();
        }
      });
      $('#cancha_numero_select').val('');
    });
    
    // Advertencia de coincidencias de nombre o apellido
    var jugadores = [
      {% for jugador in jugadores_registrados %}
        { nom: "{{ jugador.nom|escapejs }}", cognom: "{{ jugador.cognom|escapejs }}", id: "{{ jugador.id_jugador }}" },
      {% endfor %}
    ];
    $('#jugador_select').on('change', function() {
      var selected = $(this).val();
      var [nom, cognom] = selected.split('|');
      var coincidencias = jugadores.filter(j => j.nom === nom || j.cognom === cognom);
      if (coincidencias.length > 1) {
        var msg = 'Atención: Hay jugadores con el mismo nombre o apellido. Verifica el ID antes de reservar.';
        $('#jugador-warning').text(msg).show();
      } else {
        $('#jugador-warning').hide();
      }
    });
    
    // Abrir modal automáticamente si hay parámetros GET de fecha, hora, cancha y tipo
    var urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('fecha') && urlParams.get('hora') && urlParams.get('cancha') && urlParams.get('tipo')) {
      setTimeout(function() {
        $('#formulario-popup').modal('show');
      }, 300); // pequeño delay para asegurar render
    }
  });
</script>
{% endblock %}